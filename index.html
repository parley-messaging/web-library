<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Messenger</title>
	<style>
		:root {
			--mobile-height: 1vh;
			--mobile-width: 1vw;
			--font: 'OpenSans', sans-serif;
			--background-color: #FFF;
			--background-image: ''; /* TODO: Not used */
			--nav-background-color: #00006B;
			--nav-text-color: #FFF;
			--date-color: #404040;
			--input-background-color: #218259; /* TODO: Not used */
			--input-text-color: #FFF; /* TODO: Not used */
			--user-background-color: #4BF0B9;
			--user-text-color: #00006B;
			--user-sent-color: #090; /* TODO: Not used */
			--user-time-color: #00006B;
			--account-background-color: #E7E3E0;
			--account-text-color: #535353;
			--account-time-color: #00006B;
			--info-text-color: #535353;
			--agent-name-color: rgba(0, 0, 0, 0.68);
			--button-label: false;
			--button-label-background-color: #6D83AD;
			--button-label-text-color: #FFF;
			--messenger-icon-background-color: #00006B;
			--link-color: #4891F5;
			--popup-text-color: #070721;
			--popup-close-button-background-color: var(--nav-background-color);
			--popup-text-line-height: 15px;
			--popup-textarea-color: #6A6A7A;
			--close-alert-left-button-background-color: var(--nav-background-color);
			--close-alert-left-button-color: #FFF;
			--close-alert-right-button-background-color: #E6E6E8;
			--close-alert-right-button-color: #070721;
			--shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
		}
	</style>

	<link href="index.css" rel="stylesheet">
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet"
		  integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/url-search-params-polyfill@8.1.0/index.min.js"></script>
</head>
<body>
<iframe width="0" height="0" class="hidden" name="dummyframe" id="dummyframe"></iframe>

<section id="loginContainer">
	<div id="startChatOptions">
		<form onsubmit="createChat()" action="#" target="dummyframe" autocomplete="on">
			<div class="form-group">
				<label for="accountId">Account Identification</label>
				<input type="text" id="accountId" class="form-control" placeholder="identification" required/>
			</div>
			<div class="form-group">
				<label for="apiDomain">Api Domain</label>
				<input type="text" id="apiDomain" class="form-control" placeholder="api domain"
					   value="https://api.parley.nu" required/>
			</div>
			<div class="form-group">
				<label for="background">Background</label>
				<input type="text" id="background" class="form-control" placeholder="background url"
					   value=""/>
			</div>
			<button type="submit" class="btn btn-primary" onclick="fromButtonClick = true">Create chat</button>
		</form>
	</div>

	<div id="additionalInformation" class="hide-untill-start">
		<form onsubmit="setAdditionalInfo()" action="#" target="dummyframe" autocomplete="off">
			<div class="form-group">
				<label for="userAdditionalInformation">User additional information</label>
				<textarea id="userAdditionalInformation" class="form-control" required rows="3">{"key": "data"}</textarea>
				<small id="userAdditionalInformationError" class="hidden"></small>
			</div>
			<button id="setUserAdditionalInformation" type="submit" class="btn btn-primary">Synchronize data</button>
		</form>
	</div>
</section>

<div id="toggleOptions" class="right">
	<button class="btn btn-primary" id="toggleOptionsBtn" onclick="toggleOptions()"><</button>
</div>

<!-- Load the actual chat widget -->
<div id="app"></div>
<script src="src/UI/index.jsx" type="module"></script>
<!-- END -->
</body>
<script>
	let showOptions = true;
	let localStorageKey = "parleyDemoV2Settings";
	let fromButtonClick = false;
	let settingsUrl = "";

	// Default config used to create a chat
	let config = {
		roomNumber: '0W4qcE5aXoKq9OzvHxj2'
	};
	window.parleySettingsDemo = config;

	init();
	function init() {
		let demoSettings = JSON.parse(localStorage.getItem(localStorageKey));
		if(!demoSettings) {
			demoSettings = {};
		}

		// Check if we can set the form values from GET params
		let accountId = findGetParameter("accountId") ? findGetParameter("accountId") : demoSettings.accountId;
		document.getElementById("accountId").value = accountId ? accountId : document.getElementById("accountId").value;

		let apiDomain = findGetParameter("apiDomain") ? findGetParameter("apiDomain") : demoSettings.apiDomain;
		document.getElementById("apiDomain").value = apiDomain ? apiDomain : document.getElementById("apiDomain").value;

		let background = findGetParameter("background") ? findGetParameter("background") : demoSettings.background;
		document.getElementById("background").value = background ? background : document.getElementById("background").value;

		if(findGetParameter("start") === "true") {
			toggleOptions();
			createChat();
		}
	}

	function findGetParameter(parameterName) {
		let result = null,
			tmp = [];
		location.search
			.substr(1)
			.split("&")
			.forEach(function (item) {
				tmp = item.split("=");
				if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
			});
		return result;
	}

	function toggleOptions() {
		showOptions = !showOptions;

		if(!showOptions) {
			document.getElementById("toggleOptions").classList.add("left");
			document.getElementById("toggleOptions").classList.remove("right");
			document.getElementById("toggleOptionsBtn").innerHTML = ">";
		} else {
			document.getElementById("toggleOptions").classList.add("right");
			document.getElementById("toggleOptions").classList.remove("left");
			document.getElementById("toggleOptionsBtn").innerHTML = "<";
		}
	}

	function loadDependencies(url, identification, backgroundUrl, onLoad) {
		// Unload previous dependencies
		if(document.getElementById("parley-style")) document.head.removeChild(document.getElementById("parley-style"));
		if(document.getElementById("parley-app")) document.head.removeChild(document.getElementById("parley-app"));
		delete window.parleySettings;

		url = url+version+"/"+identification;

		// Load latest messenger.css
		let style = document.createElement('link');
		style.href = url+"/messenger.css";
		style.type = "text/css";
		style.rel = "stylesheet";
		style.id = "parley-style";
		style.onload = function() {
			// Load latest app.js
			let script = document.createElement('script');
			script.src = url+"/app.js";
			script.id = 'parley-app';
			script.onload = function() {
				// Set page's background
				document.body.style.background = "url("+backgroundUrl+") center no-repeat";
				document.body.style.backgroundSize = "100%";

				onLoad();
			};
			document.head.appendChild(script);
		};
		document.head.appendChild(style);
	}

	function createChat() {
		if(fromButtonClick === true) {
			// Reset all cookies if there were any
			window.localStorage.clear();
		}

		// Un hide all nodes with the `hide-untill-start` classname
		let nodes = document.querySelectorAll(".hide-untill-start");
		for (let i = 0; i < nodes.length; i++) {
			nodes.item(i).classList.remove("hide-untill-start");
		}

		// Get values from input fields
		config.roomNumber = document.getElementById("accountId").value;
		config.apiDomain = document.getElementById("apiDomain").value;
		let backgroundUrl = document.getElementById("background").value;
		let identification = "0W4qcE5aXoKq9OzvHxj2"; // Use this as a default identification to find the dependencies for
		let pathToDist = "https://parleycdn.com/";

		// Save settings url
		let urlSearchParams = new URLSearchParams();
		urlSearchParams.append("accountId", config.roomNumber);
		urlSearchParams.append("apiDomain", config.apiDomain);
		urlSearchParams.append("background", backgroundUrl);
		urlSearchParams.append("start", "true");
		settingsUrl = location.origin + location.pathname + "?" + urlSearchParams.toString();
		window.history.pushState("", document.title, settingsUrl);

		// Save settings into cookie and load on page refresh
		localStorage.setItem(localStorageKey, JSON.stringify({
			accountId: config.roomNumber,
			apiDomain: config.apiDomain,
			background: backgroundUrl,
		}));

		loadDependencies(pathToDist, identification, backgroundUrl, function() {
			// Create the chat with the default config and the input values
			window.parleySettings = config;

			setTimeout(function() {
				// Show invite notification so you can directly send a message
				window.parleySettings.showInviteNotification();
			}, 150);
		});

		return false; // To cancel the form's submit
	}

	function loginChat() {
		document.getElementById("login").disabled = true;
		let authHeader = document.getElementById("authHeader").value;

		window.parleySettings.registerNewDevice(authHeader, function(){
			alert("You are now logged in!");

			document.getElementById("logout").disabled = false;
		}, function(){
			alert("Something went wrong while logging in, please refresh and try again.");
		});

		return false; // To cancel the form's submit
	}

	function logoutChat() {
		window.parleySettings.registerNewDevice("");
		window.parleySettings.hideParleyMessenger();
		setTimeout(function() {
			// Show invite notification so you can directly send a message
			window.parleySettings.showInviteNotification();
		}, 150);

		alert("You have been logged out!");

		document.getElementById("login").disabled = false;
		document.getElementById("logout").disabled = true;
	}

	function setAdditionalInfo() {
		try {
			let value = document.getElementById("userAdditionalInformation").value;

			let json = JSON.parse(value);
			document.getElementById("userAdditionalInformationError").innerHTML = "";
			document.getElementById("userAdditionalInformationError").classList.add("hidden");
		} catch (e) {
			document.getElementById("userAdditionalInformationError").innerHTML = e.message;
			document.getElementById("userAdditionalInformationError").classList.remove("hidden");

			return false;
		}

		window.parleySettings.userAdditionalInformation = json;
		alert("User additional information has been send to the server!");
		return false; // Cancel form's submit
	}
</script>
</html>
